import React, { useState, useEffect } from "react";
import {
    BarChart, Bar, PieChart, Pie, Cell, AreaChart, Area,
    XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, CartesianGrid,
    RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar
} from "recharts";
import {
    Users, Calendar, Activity, CheckCircle, AlertTriangle, TrendingUp,
    Sun, Moon, Download, Filter, Clock, DollarSign, Target,
    AlertCircle, ChevronRight, UserCheck, MessageSquare, Award, Package,
    FileText, Shield, Wrench, FileCheck, Search, Bell, Settings,
    MapPin, Phone, Mail, Briefcase, Star, BarChart3, TrendingDown, LogOut, Send
} from "lucide-react";

// ===== GOOGLE SHEETS CONFIG =====
const GOOGLE_SHEETS = {
    tasks: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5noqQZXi5ciYwvov6OivXEQzBM0kOLVrgdSpMSnE_RGhFNrx512dpRlfxJBBeCRWOe8IyvMPfEsQW/pub?output=csv",
    team: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSNwG7-hxVDy1vV4SoiWpSaUbT7TlL83F47lzwfGkUy1x7Rlgu0NacmjgWQbbNaVvATXoAH92bepkb9/pub?output=csv",
    budget: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEtJmpiwvmUHHG3O4lsXWHnk4jbk5RArApj32WwR25y4D6Em1BwZxUPYELo8_yahSgZNqehRoXuOxM/pub?output=csv",
    materials: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKHkn_izEZZ3dNJp3bdBQVa7kGb7SJUN8Zn4yknVJWhYQn--CneRXTNd8Lfk4wuobIqaWdPNIPbB4e/pub?output=csv",
    performance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6m2UelW3u1iUJFyDdrLJfXxw68ehhGI5vT1cMUhgBcJsqAaeLMGRBFhvnRl4VW7wgthx14rsWSImo/pub?output=csv",
    photos: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvR309Cek9EY7Vwv9XQC_KxkIVsYkR_GGuYwJH_ewdVqPZ5SAauQqYso4OTKRzG3bsMKybA29EMiDj/pub?output=csv",
    commentsRead: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTI8wnG3dA07Quo6gRNqX6pwEbdTZ5FZzwT0xrCMPrtnwSytbKoa71ixG4F3em45DoqFbbanS6L9yQ2/pub?output=csv", // رابط قراءة التعليقات
    commentsWrite: "https://script.google.com/macros/s/AKfycbxEnWjRDB1nZGsWeFGkSbA_FQkmtAKX-va4eoge-vskcB4lO8NvI8Oio8ocGuzdRBiLrg/exec", // رابط Apps Script للكتابة
};

const projectName = "Kingdom Gate Tower - Low Current Systems";
const projectClient = "Al Fahd Investment - STS";
const projectContract = "SO-23_0941_001_R_08";
const projectStart = new Date(2025, 2, 1);
const projectEnd = new Date(2025, 11, 31);

export default function App() {
    // Auth State
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [loginForm, setLoginForm] = useState({ username: "", password: "" });
    const [loginError, setLoginError] = useState("");

    // UI State
    const [view, setView] = useState("Overview");
    const [darkMode, setDarkMode] = useState(false);
    const [selectedSystem, setSelectedSystem] = useState("All");
    const [filterStatus, setFilterStatus] = useState("All");
    const [filterOwner, setFilterOwner] = useState("All");
    const [filterTeam, setFilterTeam] = useState("All");
    const [showFilters, setShowFilters] = useState(false);
    const [searchQuery, setSearchQuery] = useState("");
    const [showNotifications, setShowNotifications] = useState(false);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState("");
    const [modalPhoto, setModalPhoto] = useState(null);

    // Data State
    const [tasksData, setTasksData] = useState([]);
    const [teamData, setTeamData] = useState([]);
    const [budgetData, setBudgetData] = useState([]);
    const [materialsData, setMaterialsData] = useState([]);
    const [commentsData, setCommentsData] = useState([]);
    const [timelineData, setTimelineData] = useState([]);
    const [performanceData, setPerformanceData] = useState([]);
    const [photosData, setPhotosData] = useState([]);
    const [milestonesData, setMilestonesData] = useState([]);
    const [notifications, setNotifications] = useState([]);

    // Comment Form State
    const [newComment, setNewComment] = useState("");
    const [commentPriority, setCommentPriority] = useState("Medium");
    const [submittingComment, setSubmittingComment] = useState(false);

    // Check if user is logged in on mount
    useEffect(() => {
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser) {
            setCurrentUser(JSON.parse(savedUser));
            setIsLoggedIn(true);
        }
    }, []);

    // Parse CSV Helper
    const parseCSV = (text) => {
        const lines = text.split("\n").filter(line => line.trim() !== "");
        if (lines.length === 0) return [];
        const headers = lines[0].split(",").map(h => h.trim());
        return lines.slice(1).map(line => {
            const values = line.split(",");
            const obj = {};
            headers.forEach((header, index) => {
                obj[header] = values[index]?.trim() || "";
            });
            return obj;
        });
    };

    // Fetch Comments
    const fetchComments = async () => {
        if (!GOOGLE_SHEETS.commentsRead) return;
        try {
            const res = await fetch(GOOGLE_SHEETS.commentsRead);
            const text = await res.text();
            setCommentsData(parseCSV(text));
        } catch (err) {
            console.error("Failed to fetch comments:", err);
        }
    };

    // Fetch Data
    useEffect(() => {
        if (!isLoggedIn) return;

        const fetchData = async () => {
            setLoading(true);
            try {
                // Fetch all sheets
                if (GOOGLE_SHEETS.tasks) {
                    const res = await fetch(GOOGLE_SHEETS.tasks);
                    setTasksData(parseCSV(await res.text()));
                }
                if (GOOGLE_SHEETS.team) {
                    const res = await fetch(GOOGLE_SHEETS.team);
                    setTeamData(parseCSV(await res.text()));
                }
                if (GOOGLE_SHEETS.budget) {
                    const res = await fetch(GOOGLE_SHEETS.budget);
                    const data = parseCSV(await res.text()).map(d => ({
                        ...d,
                        allocated: Number(d.allocated) || 0,
                        spent: Number(d.spent) || 0,
                        remaining: Number(d.remaining) || 0
                    }));
                    setBudgetData(data);
                }
                if (GOOGLE_SHEETS.materials) {
                    const res = await fetch(GOOGLE_SHEETS.materials);
                    setMaterialsData(parseCSV(await res.text()));
                }
                if (GOOGLE_SHEETS.performance) {
                    const res = await fetch(GOOGLE_SHEETS.performance);
                    const data = parseCSV(await res.text()).map(d => ({
                        ...d,
                        productivity: Number(d.productivity) || 0,
                        quality: Number(d.quality) || 0,
                        teamwork: Number(d.teamwork) || 0,
                        reliability: Number(d.reliability) || 0
                    }));
                    setPerformanceData(data);
                }
                if (GOOGLE_SHEETS.photos) {
                    const res = await fetch(GOOGLE_SHEETS.photos);
                    setPhotosData(parseCSV(await res.text()));
                }

                await fetchComments();

                setNotifications([
                    { id: 1, type: "warning", message: "3 tasks approaching deadline", time: "2 hours ago" },
                    { id: 2, type: "info", message: "Weekly progress meeting on Monday 9AM", time: "5 hours ago" },
                    { id: 3, type: "success", message: "Phase 1 milestone completed", time: "1 day ago" },
                ]);
            } catch (err) {
                console.error("Failed to fetch data:", err);
            }
            setLoading(false);
        };

        fetchData();
    }, [isLoggedIn]);

    // Handle Login
    const handleLogin = () => {
        setLoginError("");

        const users = {
            "admin": { password: "admin123", name: "Admin User", email: "admin@project.com", role: "Admin" },
            "bakri": { password: "bakri123", name: "Bakri Mohammed", email: "bakri@project.com", role: "Project Manager" },
            "viewer": { password: "viewer123", name: "Viewer", email: "viewer@project.com", role: "Viewer" }
        };

        const user = users[loginForm.username];
        if (user && user.password === loginForm.password) {
            const userData = { username: loginForm.username, ...user };
            setCurrentUser(userData);
            setIsLoggedIn(true);
            localStorage.setItem("currentUser", JSON.stringify(userData));
        } else {
            setLoginError("Invalid username or password");
        }
    };

    // Handle Logout
    const handleLogout = () => {
        setIsLoggedIn(false);
        setCurrentUser(null);
        localStorage.removeItem("currentUser");
        setLoginForm({ username: "", password: "" });
    };

    // Submit Comment
    const handleSubmitComment = async () => {
        if (!newComment.trim() || !GOOGLE_SHEETS.commentsWrite) return;

        setSubmittingComment(true);
        try {
            await fetch(GOOGLE_SHEETS.commentsWrite, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUser.name,
                    email: currentUser.email,
                    comment: newComment,
                    priority: commentPriority
                })
            });

            setNewComment("");
            setCommentPriority("Medium");
            alert("Comment submitted successfully!");

            setTimeout(() => fetchComments(), 2000);
        } catch (error) {
            console.error("Error:", error);
            alert("Comment submitted!");
        }
        setSubmittingComment(false);
    };

    const theme = darkMode
        ? { bg: "bg-gray-900", card: "bg-gray-800", text: "text-gray-100", border: "border-gray-700", hover: "hover:bg-gray-700" }
        : { bg: "bg-gradient-to-br from-gray-50 to-blue-50", card: "bg-white", text: "text-gray-900", border: "border-gray-200", hover: "hover:bg-gray-50" };

    const StatCard = ({ icon: Icon, title, value, subtitle, color }) => (
        <div className= {`${theme.card} rounded-xl p-6 shadow-lg border ${theme.border} transform transition-all hover:scale-105`
}>
    <div className="flex items-start justify-between mb-4" >
        <div className={ `p-3 rounded-lg bg-gradient-to-br ${color}` }>
            <Icon className="text-white" size = { 24} />
                </div>
                </div>
                < h3 className = "text-gray-500 text-sm font-medium mb-1" > { title } </h3>
                    < p className = {`text-3xl font-bold ${theme.text} mb-1`}> { value } </p>
{ subtitle && <p className="text-gray-400 text-xs" > { subtitle } </p> }
</div>
    );

// Login Screen
if (!isLoggedIn) {
    return (
        <div className= "min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4" >
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md" >
            <div className="text-center mb-8" >
                <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center" >
                    <Shield className="text-white" size = { 40} />
                        </div>
                        < h1 className = "text-3xl font-bold text-gray-800 mb-2" > Project Dashboard </h1>
                            < p className = "text-gray-600" > { projectName } </p>
                                </div>

                                < div className = "space-y-6" >
                                    <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2" > Username </label>
                                        < input
    type = "text"
    value = { loginForm.username }
    onChange = {(e) => setLoginForm({ ...loginForm, username: e.target.value })
}
className = "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
placeholder = "Enter username"
    />
    </div>

    < div >
    <label className="block text-sm font-medium text-gray-700 mb-2" > Password </label>
        < input
type = "password"
value = { loginForm.password }
onChange = {(e) => setLoginForm({ ...loginForm, password: e.target.value })}
onKeyPress = {(e) => e.key === 'Enter' && handleLogin()}
className = "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
placeholder = "Enter password"
    />
    </div>

{
    loginError && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2" >
            <AlertCircle size={ 20 } />
                < span > { loginError } </span>
                </div>
                        )
}

<button
                            onClick={ handleLogin }
className = "w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all"
    >
    Login
    </button>
    </div>

    < div className = "mt-6 p-4 bg-gray-50 rounded-lg" >
        <p className="text-sm text-gray-600 font-semibold mb-2" > Demo Accounts: </p>
            < div className = "space-y-1 text-xs text-gray-700" >
                <p>• admin / admin123 </p>
                    <p>• bakri / bakri123 </p>
                        <p>• viewer / viewer123 </p>
                            </div>
                            </div>
                            </div>
                            </div>
        );
    }

if (loading) {
    return (
        <div className= "min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center" >
        <div className="text-center" >
            <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4" > </div>
                < p className = "text-lg font-semibold text-gray-700" > Loading Dashboard...</p>
                    </div>
                    </div>
        );
}

const totalTasks = tasksData.length;
const completedTasks = tasksData.filter(t => t.status === "Completed").length;
const totalBudget = budgetData.reduce((sum, c) => sum + c.allocated, 0);
const totalSpent = budgetData.reduce((sum, c) => sum + c.spent, 0);

return (
    <div className= {`min-h-screen ${theme.bg} ${theme.text}`}>
        {/* Header */ }
        < div className = {`${theme.card} shadow-lg border-b ${theme.border}`}>
            <div className="max-w-7xl mx-auto px-6 py-6" >
                <div className="flex items-center justify-between flex-wrap gap-4" >
                    <div>
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" >
                        { projectName }
                        </h1>
                        < p className = "text-sm text-gray-500 mt-1" > Welcome, { currentUser.name } </p>
                            </div>

                            < div className = "flex items-center gap-3" >
                                <button onClick={ () => setDarkMode(!darkMode) }
className = {`p-3 rounded-lg ${theme.card} border ${theme.border}`}>
    { darkMode?<Sun size = { 20 } /> : <Moon size={ 20 } />}
</button>
    < button onClick = { handleLogout }
className = "px-6 py-3 bg-red-500 text-white rounded-lg font-semibold flex items-center gap-2 hover:bg-red-600 transition-all" >
    <LogOut size={ 20 } />Logout
        </button>
        </div>
        </div>
        </div>
        </div>

{/* Navigation */ }
<div className="max-w-7xl mx-auto px-6 mt-6" >
    <div className="flex gap-2 border-b border-gray-300 overflow-x-auto" >
    {
        ["Overview", "Tasks", "Team", "Comments"].map(tab => (
            <button key= { tab } onClick = {() => setView(tab)}
className = {`px-6 py-3 font-semibold border-b-2 whitespace-nowrap ${view === tab ? "border-blue-600 text-blue-600" : "border-transparent text-gray-500"}`}>
    { tab }
    </button>
                    ))}
</div>
    </div>

{/* Content */ }
<div className="max-w-7xl mx-auto px-6 py-8" >
    { view === "Overview" && (
        <div className="space-y-8" >
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6" >
                <StatCard icon={ Target } title = "Total Tasks" value = { totalTasks } color = "from-blue-500 to-blue-600" />
                    <StatCard icon={ CheckCircle } title = "Completed" value = { completedTasks } color = "from-green-500 to-green-600" />
                        <StatCard icon={ DollarSign } title = "Budget" value = {`SAR ${(totalBudget / 1000).toFixed(0)}K`} color = "from-purple-500 to-purple-600" />
                            <StatCard icon={ Users } title = "Team" value = { teamData.length } color = "from-orange-500 to-orange-600" />
                                </div>
                                </div>
                )}

{
    view === "Comments" && (
        <div className="space-y-6" >
            {/* Add Comment Form */ }
            < div className = {`${theme.card} rounded-xl p-6 shadow-lg border ${theme.border}`
}>
    <h3 className="text-2xl font-bold flex items-center gap-2 mb-6" >
        <MessageSquare className="text-blue-600" size = { 28} />
            Add New Comment
                </h3>
                < div className = "space-y-4" >
                    <div>
                    <label className="block text-sm font-medium mb-2" > Your Comment </label>
                        < textarea
value = { newComment }
onChange = {(e) => setNewComment(e.target.value)}
className = {`w-full px-4 py-3 rounded-lg border ${theme.border} ${theme.card} focus:ring-2 focus:ring-blue-500 min-h-[120px]`}
placeholder = "Write your comment here..."
    />
    </div>
    < div className = "flex items-center justify-between" >
        <select
                                        value={ commentPriority }
onChange = {(e) => setCommentPriority(e.target.value)}
className = {`px-4 py-2 rounded-lg border ${theme.border} ${theme.card}`}
                                    >
    <option>Low </option>
    < option > Medium </option>
    < option > High </option>
    </select>
    < button
onClick = { handleSubmitComment }
disabled = { submittingComment || !newComment.trim()}
className = "px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold flex items-center gap-2 hover:shadow-lg disabled:opacity-50"
    >
    <Send size={ 20 } />
{ submittingComment ? "Submitting..." : "Submit Comment" }
</button>
    </div>
    </div>
    </div>

{/* Comments List */ }
<div className={ `${theme.card} rounded-xl p-6 shadow-lg border ${theme.border}` }>
    <h3 className="text-2xl font-bold mb-6" > All Comments </h3>
        < div className = "space-y-4" >
            {
                commentsData.length === 0 ? (
                    <p className= "text-gray-500 text-center py-8" > No comments yet.Be the first to comment!</ p >
                                ) : (
    commentsData.map((comment, i) => (
        <div key= { i } className = {`p-5 rounded-lg border-l-4 ${comment.priority === "High" ? "border-red-500 bg-red-50" : comment.priority === "Low" ? "border-green-500 bg-green-50" : "border-blue-500 bg-blue-50"}`}>
    <div className="flex items-start justify-between mb-3" >
    <div className="flex items-center gap-3" >
    <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold" >
    { comment.username?.charAt(0) || "U" }
    </div>
    < div >
    <h4 className="font-bold" > { comment.username } </h4>
    < p className = "text-xs text-gray-500" > { comment.timestamp } </p>
    </div>
    </div>
    < span className = {`px-3 py-1 rounded-full text-xs font-semibold ${comment.priority === "High" ? "bg-red-500 text-white" : comment.priority === "Low" ? "bg-green-500 text-white" : "bg-blue-500 text-white"}`}>
    { comment.priority }
    </span>
    </div>
    < p className = "text-gray-700" > { comment.comment } </p>
    </div>
    ))
                                )}
</div>
    </div>
    </div>
                )}
</div>
    </div>
    );
}